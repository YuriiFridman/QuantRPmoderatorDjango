{% extends 'base.html' %}

{% block title %}Moderation Actions - Telegram Moderator{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-gavel me-2"></i>–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä—Å—å–∫—ñ –¥—ñ—ó</h1>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-user-times me-2"></i>–ú–æ–¥–µ—Ä—É–≤–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</h5>
            </div>
            <div class="card-body">
                <form method="post" id="moderationForm">
                    {% csrf_token %}

                    <div class="mb-3">
                        <label for="user_id" class="form-label">ID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</label>
                        <input type="number" class="form-control" id="user_id" name="user_id" required>
                    </div>

                    <div class="mb-3">
                        <label for="chat_id" class="form-label">ID —á–∞—Ç—É</label>
                        <input type="number" class="form-control" id="chat_id" name="chat_id" required>
                    </div>

                    <div class="mb-3">
                        <label for="action" class="form-label">–î—ñ—è</label>
                        <select class="form-select" id="action" name="action" required>
                            <option value="">–í–∏–±–µ—Ä—ñ—Ç—å –¥—ñ—é</option>
                            <option value="warn">‚ö†Ô∏è –ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è</option>
                            <option value="mute">üîá –ú—É—Ç</option>
                            <option value="ban">üö´ –ë–∞–Ω</option>
                            <option value="kick">üö™ –ö—ñ–∫</option>
                        </select>
                    </div>

                    <div class="mb-3" id="durationField" style="display: none;">
                        <label for="duration" class="form-label">–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å (—Ö–≤–∏–ª–∏–Ω–∏)</label>
                        <input type="number" class="form-control" id="duration" name="duration" min="1" max="43200">
                        <div class="form-text">–¢—ñ–ª—å–∫–∏ –¥–ª—è –º—É—Ç—É. –ú–∞–∫—Å–∏–º—É–º 43200 —Ö–≤–∏–ª–∏–Ω (30 –¥–Ω—ñ–≤)</div>
                    </div>

                    <div class="mb-3">
                        <label for="reason" class="form-label">–ü—Ä–∏—á–∏–Ω–∞</label>
                        <textarea class="form-control" id="reason" name="reason" rows="3" required></textarea>
                    </div>

                    <div class="mb-3">
                        <h6>–®–≤–∏–¥–∫—ñ –ø—Ä–∏—á–∏–Ω–∏:</h6>
                        <div class="d-flex flex-wrap gap-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary quick-reason" data-reason="–°–ø–∞–º">–°–ø–∞–º</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary quick-reason" data-reason="–ù–µ–Ω–æ—Ä–º–∞—Ç–∏–≤–Ω–∞ –ª–µ–∫—Å–∏–∫–∞">–ú–∞—Ç</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary quick-reason" data-reason="–†–µ–∫–ª–∞–º–∞">–†–µ–∫–ª–∞–º–∞</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary quick-reason" data-reason="–û—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è">–û—Å–∫–æ—Ä–±–ª–µ–Ω–Ω—è</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary quick-reason" data-reason="–§–ª—É–¥">–§–ª—É–¥</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary quick-reason" data-reason="–ü–æ—Ä—É—à–µ–Ω–Ω—è –ø—Ä–∞–≤–∏–ª">–ü–æ—Ä—É—à–µ–Ω–Ω—è –ø—Ä–∞–≤–∏–ª</button>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check me-2"></i>–í–∏–∫–æ–Ω–∞—Ç–∏ –¥—ñ—é
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-undo me-2"></i>–°–∫–∞—Å—É–≤–∞—Ç–∏ –ø–æ–∫–∞—Ä–∞–Ω–Ω—è</h5>
            </div>
            <div class="card-body">
                <form method="post" id="removeActionForm">
                    {% csrf_token %}

                    <div class="mb-3">
                        <label for="remove_user_id" class="form-label">ID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</label>
                        <input type="number" class="form-control" id="remove_user_id" name="user_id" required>
                    </div>

                    <div class="mb-3">
                        <label for="remove_chat_id" class="form-label">ID —á–∞—Ç—É</label>
                        <input type="number" class="form-control" id="remove_chat_id" name="chat_id" required>
                    </div>

                    <div class="mb-3">
                        <label for="remove_action" class="form-label">–°–∫–∞—Å—É–≤–∞—Ç–∏</label>
                        <select class="form-select" id="remove_action" name="action" required>
                            <option value="">–í–∏–±–µ—Ä—ñ—Ç—å –¥—ñ—é</option>
                            <option value="unban">üîì –†–æ–∑–±–∞–Ω–∏—Ç–∏</option>
                            <option value="unmute">üîä –†–æ–∑–º—É—Ç–∏—Ç–∏</option>
                            <option value="unwarn">‚úÖ –ó–Ω—è—Ç–∏ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-undo me-2"></i>–°–∫–∞—Å—É–≤–∞—Ç–∏ –ø–æ–∫–∞—Ä–∞–Ω–Ω—è
                    </button>
                </form>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-search me-2"></i>–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</h5>
            </div>
            <div class="card-body">
                <form id="checkUserForm">
                    <div class="input-group">
                        <input type="number" class="form-control" id="check_user_id" placeholder="ID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞" required>
                        <button type="submit" class="btn btn-outline-primary">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </form>
                <div id="userInfo" class="mt-3" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>

<script>
// –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è –º—É—Ç–∞
document.getElementById('action').addEventListener('change', function() {
    const durationField = document.getElementById('durationField');
    if (this.value === 'mute') {
        durationField.style.display = 'block';
        document.getElementById('duration').required = true;
    } else {
        durationField.style.display = 'none';
        document.getElementById('duration').required = false;
    }
});

// –ë—ã—Å—Ç—Ä—ã–µ –ø—Ä–∏—á–∏–Ω—ã
document.querySelectorAll('.quick-reason').forEach(button => {
    button.addEventListener('click', function() {
        document.getElementById('reason').value = this.dataset.reason;
    });
});

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
document.getElementById('checkUserForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const userId = document.getElementById('check_user_id').value;
    const userInfo = document.getElementById('userInfo');

    try {
        const response = await axios.get(`/api/user/${userId}/`);
        const data = response.data;

        let html = `
            <div class="alert alert-info">
                <h6><i class="fas fa-user me-2"></i>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á ID: ${data.user_id}</h6>
                <p><strong>–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä:</strong> ${data.is_moderator ? '–¢–∞–∫' : '–ù—ñ'}</p>
                <p><strong>–ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ–∫–∞—Ä–∞–Ω—å:</strong> ${data.punishments.length}</p>
            </div>
        `;

        if (data.punishments.length > 0) {
            html += '<h6>–û—Å—Ç–∞–Ω–Ω—ñ –ø–æ–∫–∞—Ä–∞–Ω–Ω—è:</h6><ul class="list-group list-group-flush">';
            data.punishments.slice(0, 5).forEach(punishment => {
                html += `
                    <li class="list-group-item d-flex justify-content-between">
                        <span><strong>${punishment.punishment_type}</strong>: ${punishment.reason}</span>
                        <small class="text-muted">${new Date(punishment.timestamp).toLocaleString()}</small>
                    </li>
                `;
            });
            html += '</ul>';
        }

        userInfo.innerHTML = html;
        userInfo.style.display = 'block';
    } catch (error) {
        userInfo.innerHTML = '<div class="alert alert-danger">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</div>';
        userInfo.style.display = 'block';
    }
});
</script>
{% endblock %}